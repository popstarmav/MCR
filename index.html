                function initializeStockChart() {
                    const chartContainer = document.getElementById('stock-chart');
                    const chart = LightweightCharts.createChart(chartContainer, {
                        width: chartContainer.clientWidth,
                        height: 400,
                        layout: { 
                            background: { color: '#1a1a1a' }, 
                            textColor: '#00ff00' 
                        },
                        grid: { 
                            vertLines: { color: '#333333' }, 
                            horzLines: { color: '#333333' } 
                        },
                        timeScale: { 
                            timeVisible: true, 
                            secondsVisible: false,
                            borderColor: '#00ff00'
                        },
                        crosshair: {
                            mode: LightweightCharts.CrosshairMode.Normal,
                            vertLine: {
                                color: '#00ff00',
                                width: 1,
                                style: LightweightCharts.LineStyle.Dashed,
                            },
                            horzLine: {
                                color: '#00ff00',
                                width: 1,
                                style: LightweightCharts.LineStyle.Dashed,
                            },
                        },
                    });

                    const candlestickSeries = chart.addCandlestickSeries({
                        upColor: '#00ff00',
                        downColor: '#ff0000',
                        wickUpColor: '#00ff00',
                        wickDownColor: '#ff0000',
                        borderVisible: false,
                    });

                    let bidPrice = 100.00;
                    let spread = 0.20;
                    let marketData = [];
                    let cash = 10000;
                    let shares = 0;
                    let time = Math.floor(Date.now() / 1000);

                    // Market participants
                    const marketParticipants = [
                        { name: "Institutional Investor", cash: 500000, shares: 500, buyChance: 0.35, sellChance: 0.25, impact: 0.05 },
                        { name: "Day Trader", cash: 25000, shares: 100, buyChance: 0.45, sellChance: 0.45, impact: 0.02 },
                        { name: "Retail Investor", cash: 10000, shares: 20, buyChance: 0.3, sellChance: 0.2, impact: 0.01 },
                        { name: "Hedge Fund", cash: 1000000, shares: 1000, buyChance: 0.2, sellChance: 0.3, impact: 0.1 }
                    ];

                    const bidPriceDisplay = document.getElementById('stock-bid-price');
                    const askPriceDisplay = document.getElementById('stock-ask-price');
                    const cashDisplay = document.getElementById('stock-cash');
                    const sharesDisplay = document.getElementById('stock-shares');
                    const portfolioDisplay = document.getElementById('stock-portfolio');

                    function generateInitialMarketData() {
                        const basePrice = 100.00;
                        const volatility = 2.0;
                        
                        // Generate data for the past 30 periods
                        for (let i = 0; i < 30; i++) {
                            // Simulate some market movement
                            if (i > 0) {
                                const prevClose = marketData[i-1].close;
                                const change = (Math.random() - 0.5) * volatility;
                                bidPrice = Math.max(50, Math.min(150, prevClose + change));
                            } else {
                                bidPrice = basePrice;
                            }
                            
                            const high = bidPrice + Math.random() * volatility;
                            const low = bidPrice - Math.random() * volatility;
                            
                            marketData.push({
                                time: time - (30 - i) * 3600, // Hourly candles
                                open: i === 0 ? basePrice : marketData[i-1].close,
                                high: Math.max(high, bidPrice),
                                low: Math.min(low, bidPrice),
                                close: bidPrice
                            });
                        }
                        
                        // Set the data to the chart
                        candlestickSeries.setData(marketData);
                    }

                    function simulateMarketActivity() {
                        marketParticipants.forEach(participant => {
                            const decision = Math.random();
                            const lotSize = Math.floor(Math.random() * 5) + 1;
                            
                            if (decision < participant.buyChance && participant.cash >= (bidPrice + spread) * lotSize) {
                                participant.cash -= (bidPrice + spread) * lotSize;
                                participant.shares += lotSize;
                                bidPrice += participant.impact * (lotSize / 10);
                            } else if (decision > (1 - participant.sellChance) && participant.shares >= lotSize) {
                                participant.cash += bidPrice * lotSize;
                                participant.shares -= lotSize;
                                bidPrice -= participant.impact * (lotSize / 10);
                            }
                        });
                        
                        // Ensure price stays within reasonable bounds
                        bidPrice = Math.max(50, Math.min(150, bidPrice));
                        spread = 0.10 + Math.random() * 0.30;
                    }

                    function updateMarketData() {
                        simulateMarketActivity();
                        
                        const currentTime = Math.floor(Date.now() / 1000);
                        const lastCandle = marketData[marketData.length - 1];
                        
                        // Create a new candle every hour
                        if (currentTime - lastCandle.time >= 3600) {
                            const newCandle = {
                                time: currentTime,
                                open: lastCandle.close,
                                high: bidPrice + Math.random(),
                                low: bidPrice - Math.random(),
                                close: bidPrice
                            };
                            
                            marketData.push(newCandle);
                            candlestickSeries.update(newCandle);
                            
                            // Keep only the last 100 candles for performance
                            if (marketData.length > 100) {
                                marketData.shift();
                                candlestickSeries.setData(marketData);
                            }
                        } else {
                            // Update the current candle
                            const updatedCandle = {
                                ...lastCandle,
                                close: bidPrice,
                                high: Math.max(lastCandle.high, bidPrice),
                                low: Math.min(lastCandle.low, bidPrice)
                            };
                            
                            marketData[marketData.length - 1] = updatedCandle;
                            candlestickSeries.update(updatedCandle);
                        }
                    }

                    function updateUI() {
                        bidPriceDisplay.textContent = bidPrice.toFixed(2);
                        askPriceDisplay.textContent = (bidPrice + spread).toFixed(2);
                        cashDisplay.textContent = Math.floor(cash);
                        sharesDisplay.textContent = shares;
                        portfolioDisplay.textContent = Math.floor(cash + shares * bidPrice);
                    }

                    // Buy button event listener
                    document.getElementById('stock-buy-btn').addEventListener('click', () => {
                        const askPrice = bidPrice + spread;
                        const lotSize = 1;
                        const cost = askPrice * lotSize;
                        
                        if (cash >= cost) {
                            cash -= cost;
                            shares += lotSize;
                            bidPrice += 0.05; // Small market impact
                            updateMarketData();
                            updateUI();
                        } else {
                            alert("Insufficient funds to buy shares!");
                        }
                    });

                    // Sell button event listener
                    document.getElementById('stock-sell-btn').addEventListener('click', () => {
                        if (shares > 0) {
                            const lotSize = 1;
                            const revenue = bidPrice * lotSize;
                            
                            cash += revenue;
                            shares -= lotSize;
                            bidPrice -= 0.05; // Small market impact
                            updateMarketData();
                            updateUI();
                        } else {
                            alert("No shares to sell!");
                        }
                    });

                    // Market update loop
                    function updateMarket() {
                        updateMarketData();
                        updateUI();
                        setTimeout(updateMarket, 1000); // Update every second
                    }

                    // Handle window resize
                    window.addEventListener('resize', () => {
                        chart.applyOptions({ width: chartContainer.clientWidth });
                        chart.timeScale().fitContent();
                    });

                    // Initialize and start the market simulation
                    generateInitialMarketData();
                    updateUI();
                    updateMarket();
                }
            }
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchMyMemecoins();
            startEfficiencyClock();
            startPokemonTradingView();
            startStockMarketApp();
            
            // Update memecoin data for demo purposes
            setTimeout(() => {
                updateMemecoin("$MCR", 1500000, 50000);
                setApprovedCount(10);
            }, 2000);
        });
    </script>
</body>
</html>

